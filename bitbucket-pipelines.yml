image: rust:latest

clone:
      depth: full

definitions:
      caches:
            sonar: /root/.sonar/cache  # Caching SonarCloud artifacts will speed up your build
            cargo: /usr/local/cargo
            cargo-target: $BITBUCKET_CLONE_DIR/target
      steps:
      - step: &fmt
              name: Check Source Code Formating
              caches:
              - cargo
              script:
              - rustup component add rustfmt
              - cargo fmt --all -- --check
      - step: &clippy
              name: Static Code Analysis
              caches:
              - cargo
              script:
              - rustup component add clippy
              - cargo clippy --all-targets --all-features -- -D warnings
      - step: &build
              name: Build
              caches:
              - cargo
              - cargo-target
              script:
              - cargo build -v
      - step: &sonarcloud
              name: SonarCloud
              caches:
              - sonar
              script:
              - pipe: sonarsource/sonarcloud-scan:1.4.0
      - step: &sonarcloud-gate
              name: SonarCloud Quality Gate
              caches:
              - sonar
              script:
              - pipe: sonarsource/sonarcloud-scan:1.4.0
              - pipe: sonarsource/sonarcloud-quality-gate:0.1.6
      - step: &test
              name: Test
              caches:
              - cargo
              - cargo-target
              script:
              - curl -L https://github.com/mozilla/grcov/releases/latest/download/grcov-linux-x86_64.tar.bz2 | tar jxf -
              - export RUSTFLAGS="-Zprofile -Ccodegen-units=1 -Copt-level=0 -Clink-dead-code -Coverflow-checks=off"
              - cargo test -v
              - apt-get update && apt-get install --yes zip
              - |
                zip -0 ccov.zip `find . \( -name "backgammon*.gc*" \) -print`;
                ./grcov ccov.zip -s . -t lcov --llvm --branch --ignore-not-existing --ignore "/*" -o lcov.info;
                bash <(curl -s https://codecov.io/bash) -f lcov.info;
      - step: &audit
              name: Audit
              caches:
              - cargo
              script:
              - cargo install cargo-audit
              - cargo audit
      - step: &deployment
              name: Deploy to Crates
              deployment: Crates
              caches:
              - cargo
              - cargo-target
              trigger: manual
              script:
              - cargo login $CARGO_TOKEN
              - cargo publish

pipelines:
  default:
      - step: *fmt
      - step: *clippy
      - step: *sonarcloud
      - step: *test
  branches:
    master:
      - step: *fmt
      - step: *clippy
      - step: *sonarcloud-gate
      - step: *audit
      - step: *build
      - step: *test
      - step: *deployment
  pull-requests:
    '**':
      - step: *fmt
      - step: *clippy
      - step: *sonarcloud
      - step: *audit
      - step: *build
      - step: *test
